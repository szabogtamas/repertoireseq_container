---
title: ! params$report_title
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
params:
  report_title: "B-cell repertoire analysis template"
  report_author: "Anonymus"
  tagged_repertoire: "../test_data/merged_repertoire.csv"
  sample_metadata: "../test_data/samples_meta.csv"
---

## Settings

```{r}
# Import packages

library(tidyr)
library(purrr)
library(ggplot2)
library(immunarch)
library(pheatmap)
```

```{r}
# Rearrange repertoire table

merged_repertoire <- read.csv(params$tagged_repertoire)
repertoire_folder <- "reconstructed_bcrs"
if (!dir.exists(repertoire_folder)) dir.create(repertoire_folder)

preprocessed_reptabs <- merged_repertoire %>%
  group_split(Sample_code) %>%
  setNames(., .$Sample_code) %>%
  select(-Sample_code) %>%
  imap(~write.csv(.x, paste(.y, "txt", sep=".")))
```

```{r}
# Parse files with Immunarch

immdata <- repLoad(repertoire_folder)
unlink(repertoire_folder, recursive=TRUE, force=TRUE)
```

```{r}
# Add metadata

raw_metadata <- read.csv(params$sample_metadata)
immdata$meta <- left_join(immdata$meta, raw_metadata, by="Sample")
```