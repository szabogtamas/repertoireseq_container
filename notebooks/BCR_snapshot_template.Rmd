---
title: ! params$report_title
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
params:
  report_title: "B-cell repertoire analysis template"
  report_author: "Anonymus"
  tagged_repertoire: "../test_data/merged_repertoire.csv"
  sample_metadata: "../test_data/samples_meta.csv"
---

## Settings

```{r}
# Import packages

library(tidyr)
library(purrr)
library(ggplot2)
library(immunarch)
library(pheatmap)
```

```{r}
# Rearrange repertoire table

merged_repertoire <- read.csv(params$tagged_repertoire)
repertoire_folder <- "reconstructed_bcrs"
if (!dir.exists(repertoire_folder)) dir.create(repertoire_folder)

preprocessed_reptabs <- merged_repertoire %>%
  group_split(Sample_code) %>%
  setNames(., .$Sample_code) %>%
  select(-Sample_code) %>%
  imap(~write.csv(.x, paste(.y, "txt", sep=".")))
```

```{r}
# Parse files with Immunarch

immdata <- repLoad(repertoire_folder)
unlink(repertoire_folder, recursive=TRUE, force=TRUE)
```

```{r}
# Add metadata

raw_metadata <- read.csv(params$sample_metadata)
immdata$meta <- left_join(immdata$meta, raw_metadata, by="Sample")
```

## Clonotype frequencies

```{r}
chain <- "IGL"
dfs <- list()
for (s in paste0("R", seq(1:16))){
  df <-  as.data.frame(immdata$data[[s]])
  df <- df[substr(df$V.name, 1, 3) == chain,]
  df$group <- sampleInfo[s, "group"]
  df$sample <- sampleInfo[s, "sample"]
  dfs[[s]] <- df
}
dfs <- do.call("rbind", dfs)
head(dfs)
```
```

```{r}
sampleDict <- sampleInfo$group
names(sampleDict) <- sampleInfo$sample
lambda_clone_presence <- dfs %>%
  .[,c("sample", "CDR3.aa", "Proportion")] %>%
  count(CDR3.aa, sample) %>%
  tibble::add_column(th=ifelse(.$n > 0, 1, 0)) %>%
  tibble::add_column(group=sampleDict[.$sample]) %>%
  .[,c("group", "CDR3.aa", "th")] %>%
  count(CDR3.aa, group) %>%
  pivot_wider(names_from=CDR3.aa, values_from=n, values_fill=0) %>%
  as.data.frame() %>%
  `rownames<-`(.[,1]) %>%
  .[,-1]  %>%
  t() %>%
  .[order(rowSums(.[,-1]), decreasing=TRUE),]
head(lambda_clone_presence)
```

```{r}
lambda_clone_portions <- dfs %>%
  .[,c("sample", "CDR3.aa", "Proportion")] %>%
  pivot_wider(names_from=CDR3.aa, values_from=Proportion, values_fn=list(Proportion=sum), values_fill=0) %>%
  as.data.frame() %>%
  `rownames<-`(.[,1]) %>%
  .[,-1]  %>%
  t() %>%
  .[order(rowSums(.[,-1]), decreasing=TRUE),]
head(lambda_clone_portions)
```