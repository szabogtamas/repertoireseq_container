---
title: !r params$report_title
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
params:
  report_title: "B-cell repertoire analysis template"
  report_author: "Anonymus"
  tagged_repertoire: "../test_data/merged_repertoire.csv"
  sample_metadata: "../test_data/samples_meta.csv"
---

## Settings

```{r}
# Import packages

library(tidyr)
library(purrr)
library(ggplot2)
library(immunarch)
library(pheatmap)
```

```{r}
# Rearrange repertoire table to match Immunarch expectations

repertoire_folder <- "reconstructed_bcrs"
if (!dir.exists(repertoire_folder)) dir.create(repertoire_folder)

params$tagged_repertoire %>%
  read.csv(stringsAsFactors = FALSE) %>%
  group_split(Sample_code) %>%
  walk(function(x) {
    fn <- x$Sample_code %>%
      unique() %>%
      file.path(repertoire_folder, .)
    write.table(
      select(x, -Sample_code), paste(fn, "txt", sep="."),
      sep="\t", row.names=FALSE, quote = FALSE
    )
  })
```

```{r}
# Parse files with Immunarch

immdata <- repLoad(repertoire_folder)
unlink(repertoire_folder, recursive=TRUE, force=TRUE)
```

```{r}
# Add metadata

raw_metadata <- read.csv(params$sample_metadata)
immdata$meta <- left_join(immdata$meta, raw_metadata, by=c(Sample="SampleID"))
```

## Clonotype frequencies

```{r}
clonotype_freq_tab <- immdata$data %>%
  imap(~mutate(.x, SampleID = .y)) %>%
  bind_rows() %>%
  left_join(immdata$meta, by="SampleID")

head(clonotype_freq_tab)
```

```{r}
sampleDict <- sampleInfo$group
names(sampleDict) <- sampleInfo$sample
lambda_clone_presence <- dfs %>%
  .[,c("sample", "CDR3.aa", "Proportion")] %>%
  count(CDR3.aa, sample) %>%
  tibble::add_column(th=ifelse(.$n > 0, 1, 0)) %>%
  tibble::add_column(group=sampleDict[.$sample]) %>%
  .[,c("group", "CDR3.aa", "th")] %>%
  count(CDR3.aa, group) %>%
  pivot_wider(names_from=CDR3.aa, values_from=n, values_fill=0) %>%
  as.data.frame() %>%
  `rownames<-`(.[,1]) %>%
  .[,-1]  %>%
  t() %>%
  .[order(rowSums(.[,-1]), decreasing=TRUE),]
head(lambda_clone_presence)
```

```{r}
lambda_clone_portions <- dfs %>%
  .[,c("sample", "CDR3.aa", "Proportion")] %>%
  pivot_wider(names_from=CDR3.aa, values_from=Proportion, values_fn=list(Proportion=sum), values_fill=0) %>%
  as.data.frame() %>%
  `rownames<-`(.[,1]) %>%
  .[,-1]  %>%
  t() %>%
  .[order(rowSums(.[,-1]), decreasing=TRUE),]
head(lambda_clone_portions)
```

```{r}
dfs$logFreq <- log(dfs$Proportion)
ggplot(dfs, aes(x=logFreq)) +
  geom_density(aes(colour=group)) +
  theme(axis.text.x = element_text(angle=30, hjust=1)) +
  labs(title="Distribution of frequencies for Ig Lambda clonotypes")
```

```{r fig.widht=16, fig.height=4}
ggplot(dfs[dfs$Proportion > 0.003,], aes(CDR3.aa, Proportion)) +
  geom_boxplot(aes(colour=group)) +
  theme(axis.text.x = element_text(angle=30, hjust=1)) +
  labs(title="Most abundant Ig Lambda clonotypes")
```